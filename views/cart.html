<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Shop</title>
        
        <!-- Bootstrap -->
        <link rel="stylesheet" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.x/dist/css/bootstrap.min.css">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

        <!-- JQuery -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <script type="text/javascript" src="/js/common.js"></script>
        <script type="text/javascript" src="/js/login.js"></script>
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

        <!-- CSS -->
        <link rel="stylesheet" href="/css/cart.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap">

        <style>
            body {
                font-family: 'Pacifico', cursive;
            }
            #navbar-placeholder ul {
                list-style: none;
                padding: 0;
            }
            #navbar-placeholder ul li {
                display: inline;
                margin-right: 15px;
            }
            .cart-info .left-part, .cart-info .right-part, .cart-footer .footer-left, .cart-footer .footer-right {
                display: inline-block;
                vertical-align: top;
                width: 48%;
            }
            .cart-footer .footer-right {
                text-align: right;
            }
            .cart-footer .footer-right h3 {
                margin: 0;
            }
            .cart-list {
                list-style-type: none;
                padding: 0;
            }
            .cart-item {
                margin-bottom: 15px;
            }
            .cart-item .image {
                width: 100px;
                height: auto;
                display: inline-block;
                vertical-align: top;
                margin-right: 10px;
            }
            .cart-item .product-name {
                display: inline-block;
                width: 30%;
            }
            .cart-item .quantity-button, .cart-item .price, .cart-item .total {
                display: inline-block;
                width: 15%;
                text-align: center;
            }
            .blur-effect {
                filter: blur(5px);
            }
        </style>
    </head>

    <body>
        <!-- Navbar -->
        <nav id="navbar-placeholder">
            <ul class="navbar-nav"></ul>
        </nav>
        
        <div class="container-fluid" id="main-content">
            <div id="blur-effect">
                <h2 class="cart-title" id="cart-title">Your Shopping Cart</h2>
                
                <div class="cart-info" id="cart-info">
                    <div class="left-part">
                        <p>Explore our latest arrivals</p>
                        <a href="/">Continue Shopping</a>
                    </div>                  
                    <div class="right-part">
                        <p>Discover what makes us unique! <a href="/about">Learn About Us</a>.</p>
                        <p>ALL TRANSACTIONS ARE SAFE AND SECURE.</p>
                    </div>
                </div>
                
                <div class="list-title" id="list-title"></div>
                
                <div class="params">
                    <p class="perfume">Perfume</p>
                    <p>Quantity</p>
                    <p>Price</p>
                    <p>Total</p>
                </div>
                
                <div id="cart-list"></div>
                
                <div class="cart-footer" style="margin-top: 20px;">
                    <div class="footer-left">
                        <p>No promo codes available yet.</p>
                        <p>Sign up for our newsletter to be notified of future promotions!</p>
                    </div>
                    <div class="footer-right">
                        <h3 id="subtotal"></h3>
                        <h3 id="est-total"></h3>
                        <form id="checkoutForm">
                            <button type="submit" class="btn btn-primary">Proceed to checkout</button>
                        </form>
                    </div>
                </div>
                
                <footer id="footer-placeholder">
                    <ul class="footer-foot"></ul>
                </footer>
            </div>
            
            <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false" id="checkoutToast">
                <div class="toast-header">
                    <img src="https://i.pinimg.com/564x/4b/67/b2/4b67b221dad53e271950e25cc92736e0.jpg" class="rounded me-2" alt="...">
                    <strong class="me-auto" style="font-weight: bold;">Your order</strong>
                    <small class="text-body-secondary">Seamless Checkout, Speedy Delivery!</small>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div id="toast-body" class="toast-body">
                    <div id="overall-payment" class="overall"></div>
                    <div id="item-list" class="pop-up-items"></div>
                </div>
                <div id="messageContainer" style="margin-top: 5px;"></div>
                <form action="order/create" method="post" id="createOrder">
                    <button type="submit">Make an order</button>
                </form>
            </div>
        </div>

        <script>
            window.onload = function() {
                displayCartItems();
            };
        
            async function fetchWithErrorHandling(url) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                } catch (error) {
                    console.error('Fetch error:', error);
                    return null;
                }
            }
        
            async function getProducts() {
                return await fetchWithErrorHandling('/product/all');
            }
        
            async function getCartItems() {
                const cartResponse = await fetchWithErrorHandling('/api/cart');
                if (!cartResponse) return [];
        
                const cartId = cartResponse.cartId;
                if (!cartId) {
                    console.error('No cart ID found. Please log in first.');
                    return [];
                }
        
                const cartData = await fetchWithErrorHandling(`/cart/${cartId}`);
                console.log('Cart Data:', cartData);
        
                if (cartData && cartData.products) {
                    return cartData.products;
                } else {
                    console.error('No products found in cart data.');
                    return [];
                }
            }
        
            async function displayCartItems() {
                const cartItems = await getCartItems();
                const products = await getProducts();

                console.log('Cart Items:', cartItems); // Log cart items to inspect structure
                console.log('Products:', products); // Log products to inspect structure

                if (!cartItems || !products) {
                    document.getElementById('cart-list').innerHTML = '<li>Error: Cart data unavailable.</li>';
                    return;
                }

                if (cartItems.length === 0) {
                    window.location.href = '/emptyCart';
                    return;
                }

                const cartList = document.getElementById('cart-list');
                cartList.innerHTML = '';

                const cartListContainer = document.createElement('ul');
                cartListContainer.classList.add('cart-list');

                let subtotal = 0;

                cartItems.forEach(item => {
                    const product = products.find(p => p._id === item.productId._id); // Adjust this line
                    if (!product) {
                        console.error(`Product not found for item: ${item.productId._id}`); // Adjust this line
                        return;
                    }

                    const listItem = document.createElement('li');
                    listItem.classList.add('cart-item', 'row');

                    const productImage = document.createElement('img');
                    productImage.classList.add('image', 'col-sm-1');
                    productImage.src = product.imageUrl;
                    productImage.alt = product.name;

                    const productName = document.createElement('div');
                    productName.classList.add('product-name', 'col-sm-5');
                    productName.textContent = product.name;

                    const quantityButton = document.createElement('div');
                    quantityButton.classList.add('quantity-button', 'col-sm-2');
                    quantityButton.textContent = item.quantity;

                    const productPrice = document.createElement('div');
                    productPrice.classList.add('price', 'col-sm-2');
                    productPrice.textContent = `$${product.price.toFixed(2)}`;

                    const total = document.createElement('div');
                    total.classList.add('total', 'col-sm-2');
                    const totalPrice = product.price * item.quantity;
                    total.textContent = `$${totalPrice.toFixed(2)}`;

                    subtotal += totalPrice;

                    listItem.appendChild(productImage);
                    listItem.appendChild(productName);
                    listItem.appendChild(quantityButton);
                    listItem.appendChild(productPrice);
                    listItem.appendChild(total);
                    cartListContainer.appendChild(listItem);
                });

                cartList.appendChild(cartListContainer);

                document.getElementById('list-title').textContent = `Shopping bag (${cartItems.length})`;
                document.getElementById('subtotal').textContent = `Subtotal: $${subtotal.toFixed(2)}`;
                document.getElementById('est-total').textContent = `Estimated Total: $${subtotal.toFixed(2)}`;
            }
        </script>
    </body>
</html>
